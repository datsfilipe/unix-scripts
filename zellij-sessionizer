#!/usr/bin/env bash

if [[ -z $ZELLIJ_SWITCH_PATH ]]; then
  echo "ZELLIJ_SWITCH_PATH is not set"
  exit 1
fi

plugin="file://$ZELLIJ_SWITCH_PATH"

if [[ $# -eq 1 ]]; then
  selected=$1
else
  selected=$(fd --type d --max-depth 1 --min-depth 1 . ~/www/s/**/* ~/www/w/**/* | fzf --print-query)
fi

if [[ -z $selected ]]; then
  exit 0
fi

session_name=$(basename "$selected" | tr . _)

if [[ $session_name == $selected ]]; then
  zoxide_path=$(zoxide query $session_name 2>&1)
  if [[ $zoxide_path == *"no match found"* ]]; then
    exit 0
  fi
  selected=$zoxide_path
fi

zellij_running=$(pgrep zellij)

if [[ -z $ZELLIJ ]] && [[ -z $zellij_running ]]; then
  cd $selected
  zellij attach $session_name -c
  exit 0
fi

zellij pipe --plugin $plugin -- "$session_name::$selected"
